<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Media Library</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script>
    // Customize Tailwind configuration to use the desired purple accent color
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'accent-purple': '#a855f7', 
            'bg-deep': '#0d0d0d', 
            'bg-card': '#1a1a1a', 
            'text-secondary': '#b3b3b3', 
            'border-dark': '#333333', 
          },
        }
      }
    }
  </script>
  
  <style>
    /* Custom styles for specific elements not easily handled by utility classes */
    body::-webkit-scrollbar, .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Custom background for the dropdown arrow */
    .custom-select-bg {
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23ffffff'%3e%3cpath d='M9.293 12.95l.707.707L15 9.293l-1.414-1.414L10 10.586l-3.586-3.586L5 9.293l4.293 3.657z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 0.65em auto;
    }

    /* Gradient overlay for banner image to ensure text readability */
    .banner-overlay {
        background: linear-gradient(to top, rgba(13, 13, 13, 0.95), rgba(13, 13, 13, 0.5), transparent);
    }
  </style>
</head>
<body class="bg-bg-deep text-white flex flex-col h-screen overflow-hidden">
  
  <div class="header p-4 lg:px-8 bg-black shadow-lg flex justify-between items-center flex-shrink-0 z-20 border-b border-accent-purple">
    <div class="header-title text-2xl lg:text-3xl font-extrabold text-accent-purple tracking-wide">Media Catalog</div>
    <div class="flex items-center space-x-4">
        <button id="scan-button" class="scan-button bg-accent-purple text-white px-4 py-2 lg:px-6 lg:py-3 rounded-lg font-semibold shadow-md transition duration-200 hover:bg-purple-400 disabled:bg-border-dark disabled:text-text-secondary disabled:cursor-not-allowed">
          <i class="fa-solid fa-folder-open"></i> Scan Library
        </button>
        <button id="settings-button" class="text-white text-2xl p-2 rounded-full hover:bg-gray-800 transition duration-150">
            <i class="fa-solid fa-cog"></i>
        </button>
    </div>
  </div>

  <div class="content-area flex-grow flex overflow-hidden">
    
    <div id="sidebar" class="sidebar w-72 bg-bg-card overflow-y-auto border-r border-border-dark flex-shrink-0 shadow-lg no-scrollbar">
        <div id="show-list-title" class="sidebar-title px-6 pt-4 pb-3 text-lg font-bold text-text-secondary border-b border-border-dark mb-4 hidden">TV Shows</div>
        <div id="show-list-container">
            </div>
    </div>
    
    <div id="detail-view" class="detail-view flex-grow overflow-y-auto no-scrollbar relative">
        <div id="initial-state-message" class="p-8 lg:p-12">
            <h2 class="text-3xl font-bold text-accent-purple">Welcome!</h2>
            <p class="text-xl text-text-secondary mt-2">Click "**Scan Library**" above to select your root media folder and populate your catalog.</p>
        </div>
        
        </div>

  </div>
  
  <div id="status-container" class="status-message p-3 lg:px-8 bg-black text-text-secondary text-base flex-shrink-0 border-t border-border-dark flex flex-col">
      <div id="scan-status-line" class="flex items-center justify-center min-h-10">
          </div>
      <div id="metadata-progress-bar-container" class="w-full h-2 bg-border-dark rounded-full overflow-hidden transition-opacity duration-300 opacity-0 mb-1">
          <div id="metadata-progress-bar" class="h-2 bg-accent-purple transition-all duration-300" style="width: 0%"></div>
      </div>
  </div>
  
  <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm z-50 hidden flex justify-center items-center">
    <div class="bg-bg-card w-full max-w-2xl p-8 rounded-xl shadow-2xl border border-border-dark">
        <div class="flex justify-between items-center mb-6 border-b border-border-dark pb-3">
            <h2 class="text-3xl font-bold text-accent-purple">Settings</h2>
            <button id="close-settings-button" class="text-white hover:text-accent-purple text-2xl">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>

        <form id="settings-form" class="space-y-6">
            
            <div>
                <label for="media-root-path" class="block text-lg font-medium text-white mb-2">Media Folder Location</label>
                <div class="flex space-x-2">
                    <input type="text" id="media-root-path" name="mediaRootPath" class="flex-grow bg-bg-deep border border-border-dark p-3 rounded-lg text-sm" readonly placeholder="No folder selected">
                    <button type="button" id="change-root-path-button" class="bg-gray-700 text-white p-3 rounded-lg hover:bg-gray-600 transition duration-150 text-sm">
                        <i class="fa-solid fa-folder"></i> Change
                    </button>
                </div>
                <p class="text-text-secondary text-sm mt-1">This is the root directory where your TV shows are located.</p>
            </div>

            <div class="pt-4 border-t border-border-dark">
                <h3 class="text-xl font-semibold text-white mb-4">Metadata Provider (AniList)</h3>

                <div class="flex items-center justify-between mb-4">
                    <label for="use-anilist" class="text-lg font-medium text-white">Enable AniList Metadata Fetching</label>
                    <input type="checkbox" id="use-anilist" name="useAniList" class="h-6 w-12 rounded-full appearance-none bg-gray-600 checked:bg-accent-purple transition duration-200 ease-in-out cursor-pointer relative" role="switch">
                </div>

                <div>
                    <label for="anilist-api-key" class="block text-lg font-medium text-white mb-2">AniList API Key (Optional)</label>
                    <input type="password" id="anilist-api-key" name="aniListApiKey" class="w-full bg-bg-deep border border-border-dark p-3 rounded-lg text-sm" placeholder="Paste your personal access token (if needed)">
                    <p class="text-text-secondary text-sm mt-1">The public API is used by default. An optional key can be used for higher rate limits.</p>
                </div>
            </div>

            <div class="pt-6">
                <button type="submit" id="save-settings-button" class="w-full bg-accent-purple text-white py-3 rounded-lg font-semibold hover:bg-purple-400 transition duration-200">
                    <i class="fa-solid fa-save"></i> Save Settings
                </button>
            </div>
        </form>
    </div>
  </div>


  <script>
    // --- APP STATE AND INITIALIZATION ---
    let appState = {
      shows: [],
      selectedShowId: null,
      selectedSeasonIndex: 0,
      settings: {} // ADDED: Stores app settings
    };
    
    const elements = {
      sidebar: document.getElementById('sidebar'),
      showListContainer: document.getElementById('show-list-container'),
      detailView: document.getElementById('detail-view'),
      scanButton: document.getElementById('scan-button'),
      statusContainer: document.getElementById('status-container'),
      scanStatusLine: document.getElementById('scan-status-line'),
      initialMessage: document.getElementById('initial-state-message'),
      showListTitle: document.getElementById('show-list-title'),
      settingsButton: document.getElementById('settings-button'),
      settingsModal: document.getElementById('settings-modal'),
      closeSettingsButton: document.getElementById('close-settings-button'),
      settingsForm: document.getElementById('settings-form'),
      mediaRootPathInput: document.getElementById('media-root-path'),
      changeRootPathButton: document.getElementById('change-root-path-button'),
      useAniListToggle: document.getElementById('use-anilist'),
      anilistApiKeyInput: document.getElementById('anilist-api-key'),
      metadataProgressContainer: document.getElementById('metadata-progress-bar-container'),
      metadataProgressBar: document.getElementById('metadata-progress-bar'),
    };
    
    const accentColor = '#a855f7';
    const secondaryTextColor = '#b3b3b3';

    // --- UTILITY FUNCTIONS ---
    
    function setStatus(message, isError = false, isLoading = false) {
        let spinnerHTML = isLoading ? `
            <div class="w-5 h-5 border-4 border-t-4 rounded-full animate-spin mr-2" 
                 style="border-color: rgba(255, 255, 255, 0.1); border-top-color: ${accentColor};">
            </div>` : '';
            
        let color = isError ? 'red' : (isLoading ? accentColor : secondaryTextColor);
        
        elements.scanStatusLine.innerHTML = `
            <div class="scan-status-container flex items-center justify-center min-h-10" style="color:${color};">
                ${spinnerHTML} ${message}
            </div>
        `;
        elements.scanButton.disabled = isLoading;
    }
    
    // ADDED: Progress Bar UI Update Function
    function updateMetadataProgress(status, current, total, message) {
        const progressBarContainer = elements.metadataProgressContainer;
        const progressBar = elements.metadataProgressBar;
        const scanStatusLine = elements.scanStatusLine;
        
        if (status === 'start' || status === 'in-progress') {
            const percentage = (current / total) * 100;
            progressBar.style.width = `${percentage}%`;
            progressBarContainer.classList.remove('opacity-0', 'hidden');
            
            // Update the status line
            scanStatusLine.innerHTML = `
                <div class="w-5 h-5 border-4 border-t-4 rounded-full animate-spin mr-2" 
                     style="border-color: rgba(255, 255, 255, 0.1); border-top-color: ${accentColor};">
                </div>
                Metadata: ${current} of ${total} (${message})
            `;
            scanStatusLine.style.color = accentColor;
            elements.scanButton.disabled = true;

        } else if (status === 'complete') {
            progressBar.style.width = '100%';
            // Hide after a brief delay for visual effect
            setTimeout(() => {
                progressBarContainer.classList.add('opacity-0');
                progressBar.style.width = '0%';
            }, 1000);
            setStatus(message, false, false); // Reset scan status line
            elements.scanButton.disabled = false;
        }
    }


    function setSelectedShow(showId) {
        const show = appState.shows.find(s => s.id === showId);
        if (!show) return;

        appState.selectedShowId = showId;
        appState.selectedSeasonIndex = 0;
        
        // 1. Update sidebar selection class
        document.querySelectorAll('.show-list-item').forEach(el => {
            el.classList.remove('bg-gray-700', 'font-bold', 'border-accent-purple');
            el.classList.add('border-transparent');
        });
        const selectedEl = document.getElementById(`show-${showId}`);
        if(selectedEl) {
            selectedEl.classList.add('bg-gray-700', 'font-bold', 'border-accent-purple');
            selectedEl.classList.remove('border-transparent');
        }
        
        // 2. Render the detail view for the selected show
        renderDetailView(show);
    }
    
    function setSelectedSeason(seasonIndex) {
        appState.selectedSeasonIndex = parseInt(seasonIndex, 10);
        const show = appState.shows.find(s => s.id === appState.selectedShowId);
        
        if (show && show.seasons[appState.selectedSeasonIndex]) {
            renderEpisodes(show.seasons[appState.selectedSeasonIndex]);
        }
    }

    // --- RENDERING FUNCTIONS ---
    
    function renderShows() {
        if (appState.shows.length === 0) {
            elements.showListContainer.innerHTML = '';
            elements.showListTitle.classList.add('hidden');
            return;
        }

        elements.initialMessage.classList.add('hidden');
        elements.showListTitle.classList.remove('hidden');

        let listHTML = ''; 
        
        appState.shows.forEach(show => {
            const posterUrl = show.metadata?.poster || '';
            
            listHTML += `
                <div class="show-list-item px-4 py-3 cursor-pointer font-medium text-base border-l-4 border-transparent transition duration-150 hover:bg-gray-800 flex items-center space-x-3" 
                     id="show-${show.id}" 
                     data-id="${show.id}">
                    <div class="w-10 h-14 bg-gray-700 rounded-sm overflow-hidden flex-shrink-0">
                        ${posterUrl ? `<img src="${posterUrl}" alt="Poster" class="w-full h-full object-cover">` : 
                                      `<i class="fa-solid fa-tv text-xl text-text-secondary m-auto"></i>`}
                    </div>
                    <div class="truncate">${show.title}</div>
                </div>
            `;
        });
        
        elements.showListContainer.innerHTML = listHTML;
        
        // Attach click listeners to the show list items
        document.querySelectorAll('.show-list-item').forEach(el => {
            el.addEventListener('click', (e) => {
                setSelectedShow(e.currentTarget.dataset.id);
            });
        });

        // Automatically select the first show or the previously selected one
        const initialShowId = appState.selectedShowId || appState.shows[0].id;
        setSelectedShow(initialShowId);
    }
    
    function renderDetailView(show) {
        const bannerUrl = show.metadata?.banner || '';
        const description = show.metadata?.description || 'No description found. Try fetching metadata in the settings.';
        
        let detailHTML = `
            <div class="relative h-64 w-full flex-shrink-0 mb-6 bg-gray-900 overflow-hidden">
                ${bannerUrl ? 
                    `<img src="${bannerUrl}" alt="Show Banner" class="w-full h-full object-cover absolute inset-0 filter blur-sm">` : 
                    `<div class="w-full h-full flex items-center justify-center bg-gray-900"><i class="fa-solid fa-image text-5xl text-gray-700"></i></div>`
                }
                <div class="banner-overlay absolute inset-0 flex items-end p-8 lg:p-12">
                    <div class="text-white relative z-10">
                        <h1 class="show-title text-5xl font-extrabold mb-2">${show.title}</h1>
                        <p class="show-metadata text-text-secondary text-base max-w-4xl line-clamp-2">${description}</p>
                    </div>
                </div>
            </div>

            <div class="p-8 lg:p-12 pt-0">
                <p class="show-metadata text-text-secondary text-sm mt-1 mb-4">Root Path: ${show.rootPath}</p>

                <select id="season-select" class="season-selector custom-select-bg bg-gray-700 text-white p-3 lg:px-5 border border-gray-600 rounded-lg text-xl cursor-pointer mb-8 w-full max-w-sm appearance-none">
                    ${show.seasons.map((season, index) => `
                        <option value="${index}" ${index === appState.selectedSeasonIndex ? 'selected' : ''}>
                            ${season.title} (${season.episodes.length} episodes)
                        </option>
                    `).join('')}
                </select>
                
                <div id="episode-list-container">
                    </div>
            </div>
        `;
        
        elements.detailView.innerHTML = detailHTML;
        
        const seasonSelect = document.getElementById('season-select');
        if (seasonSelect) {
            seasonSelect.addEventListener('change', (e) => {
                setSelectedSeason(e.target.value);
            });
        }
        
        const initialSeason = show.seasons[appState.selectedSeasonIndex];
        if (initialSeason) {
            renderEpisodes(initialSeason);
        } else {
            document.getElementById('episode-list-container').innerHTML = '<p class="text-text-secondary">No episodes found in this season.</p>';
        }
    }
    
    function renderEpisodes(season) {
        const container = document.getElementById('episode-list-container');
        if (!container) return;

        let episodeHTML = '<div class="episode-list grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">';
        
        season.episodes.forEach((episode, index) => {
            const episodeNumber = index + 1; 
            const description = episode.description || 'No episode description available. Fetching metadata may provide one.';

            episodeHTML += `
                <div class="episode-card bg-bg-card rounded-xl overflow-hidden flex shadow-2xl border border-border-dark transition duration-200 hover:transform hover:-translate-y-1 hover:shadow-accent-purple/30 hover:border-accent-purple">
                    <div class="episode-template-img w-32 min-h-36 bg-gray-800 flex flex-col items-center justify-center text-xl font-bold text-accent-purple p-2 text-center leading-tight bg-gradient-to-br from-gray-800 to-bg-card flex-shrink-0">
                        S${appState.selectedSeasonIndex + 1} E${episodeNumber}
                    </div>
                    <div class="episode-info p-4 flex-grow flex flex-col justify-between">
                        <div>
                            <div class="episode-title text-lg font-bold mb-1">${episode.title}</div>
                            <div class="episode-description text-sm text-text-secondary line-clamp-2 mb-3">${description}</div>
                        </div>
                        <button class="play-button bg-accent-purple text-white px-4 py-2 text-sm rounded-md font-semibold transition duration-200 hover:bg-purple-400 self-start mt-1" data-path="${episode.fullPath}">
                            <i class="fa-solid fa-play"></i> Play
                        </button>
                    </div>
                </div>
            `;
        });
        
        episodeHTML += '</div>';
        container.innerHTML = episodeHTML;
        
        // Attach click listeners to all Play buttons
        document.querySelectorAll('.play-button').forEach(button => {
            button.addEventListener('click', async (e) => {
                const filePath = e.currentTarget.dataset.path;
                
                const episodeFileName = filePath.substring(filePath.lastIndexOf('/') + 1) || 
                                       filePath.substring(filePath.lastIndexOf('\\') + 1) || 
                                       filePath;
                
                setStatus(`Launching ${episodeFileName}...`, false, true);
                
                const response = await window.api.launchExternal(filePath);
                
                if (response.success) {
                    setStatus('Launched successfully in external player.', false, false);
                } else {
                    setStatus(`Launch failed for ${episodeFileName}: ${response.error}`, true, false);
                }
            });
        });
    }

    // --- SETTINGS MANAGEMENT ---
    
    async function loadSettings() {
        const response = await window.api.loadSettings();
        if (response.success) {
            appState.settings = response.settings;
            // Apply settings to the UI
            elements.mediaRootPathInput.value = response.settings.mediaRootPath || '';
            elements.useAniListToggle.checked = response.settings.useAniList;
            elements.anilistApiKeyInput.value = response.settings.aniListApiKey || '';
            
            // Set the scan button root path if it's saved
            if (response.settings.mediaRootPath) {
                elements.scanButton.dataset.rootPath = response.settings.mediaRootPath;
            }
        } else {
            setStatus(`Settings Error: ${response.message}`, true, false);
        }
    }

    async function saveSettings(settings) {
        const response = await window.api.saveSettings(settings);
        if (response.success) {
            // Update app state and UI on successful save
            appState.settings = { ...settings, _rev: response.rev }; 
            elements.mediaRootPathInput.value = settings.mediaRootPath || '';
            elements.scanButton.dataset.rootPath = settings.mediaRootPath;
            setStatus('Settings saved.', false, false);
            // Close the modal after saving
            elements.settingsModal.classList.add('hidden');
        } else {
            setStatus(`Save Error: ${response.message}`, true, false);
        }
    }

    // --- MAIN EVENT HANDLERS ---
    
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Load settings first
        loadSettings().then(() => {
            // 2. Load cached library data
            window.api.fetchLibraryCache().then(response => {
                if (response.shows && response.shows.length > 0) {
                    appState.shows = response.shows;
                    setStatus(response.message);
                    renderShows();
                    
                    // 3. Automatically trigger metadata fetch for any updates
                    if (appState.settings.useAniList) {
                        window.api.fetchMetadataForLibrary(appState.shows, appState.settings);
                    }
                } else {
                    setStatus('Ready to scan. No local cache found.', false, false);
                }
            });
        });

        // Register Metadata Progress Listener
        window.api.onMetadataProgress((data) => {
            updateMetadataProgress(data.status, data.current, data.total, data.message);
            
            // If fetching is complete, reload the library to show new metadata
            if (data.status === 'complete') {
                 window.api.fetchLibraryCache().then(response => {
                    if (response.shows && response.shows.length > 0) {
                        appState.shows = response.shows;
                        renderShows(); // Re-render the UI with new metadata
                    }
                });
            }
        });

        // Scan Button Handler
        elements.scanButton.addEventListener('click', async () => {
            let rootPath = appState.settings.mediaRootPath;

            if (!rootPath) {
                 setStatus('Please set your media folder in Settings first.', true, false);
                 return;
            }

            setStatus(`Scanning '${rootPath}'... This may take a moment.`, false, true);
            
            const response = await window.api.scanAndCacheLibrary(rootPath);
            
            if (response.success) {
                appState.shows = response.shows;
                setStatus(`Scan complete! Found ${response.shows.length} shows.`, false, false);
                renderShows(); 
                
                // Trigger metadata fetch after a successful scan
                if (appState.settings.useAniList) {
                    window.api.fetchMetadataForLibrary(appState.shows, appState.settings);
                }

            } else {
                setStatus(`Scan Error: ${response.message}`, true, false);
            }
        });
        
        // --- Settings Modal Handlers ---

        elements.settingsButton.addEventListener('click', () => {
            loadSettings(); // Reload settings before opening
            elements.settingsModal.classList.remove('hidden');
        });
        
        elements.closeSettingsButton.addEventListener('click', () => {
            elements.settingsModal.classList.add('hidden');
        });

        elements.changeRootPathButton.addEventListener('click', async () => {
            const rootPath = await window.api.openDirectoryDialog();
            if (rootPath) {
                elements.mediaRootPathInput.value = rootPath;
            }
        });

        elements.settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newSettings = {
                mediaRootPath: elements.mediaRootPathInput.value,
                useAniList: elements.useAniListToggle.checked,
                aniListApiKey: elements.anilistApiKeyInput.value.trim()
            };
            
            saveSettings(newSettings);
        });

    });
  </script>
</body>
</html>